## 自动和声问题

本文档对给定自动生成和声问题做一个简单的介绍。

### 简介

大家一定听过流行音乐，其中除了动人的旋律外，一个好的伴奏也是必不可少的。伴奏充当的角色中，和声可以说几乎是最重要的部分，它扩充了音乐时间截面上的信息含量。对于音乐创作来说，和声既是可以是简单的，例如简单的儿歌，可能只是简单的主三和弦重复；又可以是复杂的，例如很多优秀的交响乐作品通过精巧设计的和声给人带来深刻的听觉体验，无论上是时序上还是截面上。

音乐是一种艺术形式，因此具有很强的主观性，但音乐远非随机。音乐和绘画等其它艺术形式相比有一个显著的特点，它有很多条条框框。例如古典的和声学教材往往都是一本厚砖头，里面记录着人类从经验中总结的各种和声规则。因此给旋律配和声问题就是一个离散的、基于规则的问题，因此很容易描述成一个组合优化问题。

实际上从很早开始，大约在上世纪50年代，就已经出现利用计算机技术进行音乐创作的尝试，因为这个问题太清晰了，决策空间也很小，无非就是钢琴的12个音。其中绝大多数方法要么基于统计的方法，要么基于规则-检查这种方法。我们应该尝试结合这两种方法。

### 规则如何工作

我们前面说过，许多规则是基于人类的经验总结出来的，但大多数规则在今天都可以从科学的角度给出解释。所有关于和声的规则无非是从截面上和时序上对和声进行限制。用数学的语言来讲，就是一个二维矩阵，对两个维度都有限制。例如，禁止出现平行或者隐伏的八五度；低音减四度下行而不是增五度上，也就是说在do进行到升fa时应当往上走而不是往下走；避免四部同向等。很多这些规则在今天的音乐创作中会被打破，部分是因为有些规则有时代限制，但更多的是创作者水平太低。打破太多规则的音乐往往会导致音乐损失信息或者信息杂乱，导致曲子失去了长期的吸引力。我们现在听的很多所谓“口水歌”，就可以这么解释，后面提到模型时会再提一嘴。

以下这个例子里从A Major到G Major，他们的根音和五音是一个平行关系，这就违反了平行五度的规则。实际上如果你去听这个和弦进行，你会觉得本来是四个声部的东西，女高和女低好像只有一个声部，因为五度的音听起来太和谐了，就和八度一样，对应大约1.5倍和2倍的频率。

### 数学描述

有了前面的一些基本介绍，我们可以用数学的语言来精确描述这个问题。大T是时间长度，小m是用来描述旋律的维度，例如就是1，小c是用来描述和弦的维度，例如只考虑三和弦和七和弦，自然小调就是4维。其中Rule是一个规则函数，它判断一个和弦进行是否打破了规则。Score是一个分数函数，描述有多违反规则。我们一般使用score函数，因为有一些规则是软的，可以打破，但不太好，有一些规则是绝对不能碰的。一个例子，平行八五度就可以这么描述。

### 算法

很显然这是一个时序的离散优化问题，那么很自然可以提出基于搜索的回溯算法，只要从头到尾从可选集中依次选出一个和弦，遇到不可调解的矛盾就回溯到关键节点，如同CDCL算法解SAT问题。对，这个问题也可以化成SAT问题，但是会变得很冗长，因为需要用二元变量编码多元取值和时序规则。

如果加上一些forward looking的信息，还可以提出改进的带插入值的回溯算法。原因是当我们创作时不是完全按照时间顺序去解这个问题，有时候我们会提前想好，比如曲子的中间有一个离调，曲子的结尾时阻碍终止，这意味着最终可能要以六级和弦结尾，而不是主和弦。此时我们就可以要求回溯法的解必须经过这些关键节点，于是就可以做改进，回溯的时候单调扩充每个插入点之前的可行集，直到包含插入点。

### 解增强

我们说到这里，这个问题好像已经解决了。但其实这个问题和类似的问题，例如SAT，有一个显著不同的地方。SAT问题只要有一个满足就可以了，但对于和声问题，可行解一般而言数量并不少，所以其实算法很快就能找到一个可行解。问题是，这些可行解有很多其实是不好的解。例如只要拼命地使用主和弦，下属和弦和属和弦，很容易就能找到一个解。

我的意识，人类创作音乐是有模式的，例如这一步到了属七和弦，下一个和弦一般都会解决到主和弦，如果这时算法还选择一个比如二和弦，一般而言就会走到一个奇怪的地方，且就算走通了，这个解也怪怪的。所以我们可以给算法加上这种先验信息，来提高解的质量。很多具有自动作曲功能的商业软件，做法基本就是存一个很大的和弦字典，例如流行歌里的一个用烂的进行，所谓的4536251，说白了就是下属-属-主功能组的重复进行。这个和弦进行套什么旋律好像都不太会觉得难听，甚至很多流行音乐就是基于这个和弦进行来创作，因此才会有口水歌的感觉。但对于任意一个旋律，这个进行一般都不好，因此这不是我们想要的解决方案。

既然想建模模式，就可以上各种统计模型了。马尔科夫链、或者一些网络的模型，然后把这些模型作为先验加到回溯法里面。