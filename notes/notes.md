## 自动和声问题

本文档对给定自动生成和声问题做一个简单的介绍。

### 简介

我做这个主题完全是基于我的兴趣，这一块我没找到很好的工作，所以也想介绍一下。和声是什么？（对于一首曲子来说，旋律可以看成是它的时序信息，那和声就可以沿截面的信息。）为什么和声重要？（对于一首优秀的作品来讲，他的和声与旋律同样重要。）那自动和声是一个什么问题呢？（对于作曲来说，一种流行的创作方式是首先有一段旋律，然后以它为核心进行扩展，其中为这段旋律配和声，就是最先的一步，也可以认为是几乎最重要的一步，后面都是一些程序性的东西。因此，如何为旋律创作合乎逻辑且好听的和声进行，就是一个非常重要的问题。）为什么这可以是个值得研究的问题，或者说，为什么这个问题不平凡呢？（音乐发展至今已经有非常成熟的和声理论，它告诉我们什么样的和声进行不好，什么样的和声可能有什么情绪。基本上没有个几年的经验，很难快速给出一个好的和声进行，摸过钢琴的同学应该有直观的感受，随便弹几个按键大概率是很难听的。

### 规则如何工作

这里罗列了一些常见的规则，例如，禁止平行八五度以及隐伏八五度。这个图，左边这个和弦从A Major到G Major，他们的根音和五音就是平行进行，这么做听起来会感觉女高和女低只有一个声部，仿佛丢失了信息，是不太好的。所以我们大概可以感受到配和弦这件事不简单。

从数学的角度来说，这就是一个序贯决策问题，而且决策空间是离散的，且拥有基于规则的描述，当然也可以看成是一个离散优化问题。同学可以大概估计一下决策空间的量级，基本就是指数的。

### 数学描述

有了前面的一些基本介绍，我们可以用数学的语言来精确描述给旋律配和弦这个问题。大T是时间长度，小m是用来描述旋律的维度，例如就是1，小c是用来描述和弦的维度，例如只考虑三和弦和七和弦，自然小调就是4维。其中Rule是一个规则函数，它判断一个和弦进行是否打破了规则。Score是一个分数函数，描述有多违反规则。我们一般使用score函数，因为有一些规则是软的，可以打破，但不太好，有一些规则是绝对不能碰的。一个例子，平行八五度就可以这么描述。

### 相关工作

在讲我自己实现的算法之前我们快速过一下这个问题上人们已有的工作。据我所知这一块真的没什么好的工作，我觉得还挺奇怪的。我大概是半年前开始接触编曲，以我的知识背景我当时立刻就想到这个东西至少可以用强化学习方法试试，然后到这学期上这门课我觉得他就是一个很典型的组合优化问题。目前我查阅的文献来看，这一块主要是两种主流的做法，一种就是纯的基于规则-检查的方法。这一种范式在上世纪五六十年代就有人尝试，最开始是Pachet的这篇通过随机产生音符来生成弦乐四重奏。后来陆陆续续有一些这方面的工作，但只有很少用组合问题的方法来求解。在这之中有一种做法是基于字典，就是存一个很大的常见的和弦进行，然后挑一个比较好的。一些商业的作曲软件就是这么个做法，例如说流行音乐里用烂的所谓4536251进行，说白了就是下属-属-主功能组的和弦进行。另外的一类做法就是纯的基于统计模型的方法，将这个问题看作是一个抽样问题，也就是从和弦的边缘分布中抽样。这里就各种各种乱七八糟的方法就都上了，隐马尔可夫、吉布斯抽样，变分推断。最近几年有一些用深度学习来给边缘概率建模的做法。从我所看到的文章中，就没有人把这两种方法合起来。或者说没有文章从正常作曲的角度来求解这个问题。说一些我个人的看法，一个可能的原因也和这个行业有关，这个东西的经济效应不明显，因为大众基本上听不出好坏，就算你有一个算法能快速做出比4536251好的和弦，绝大多数人也听不出来。另一个原因我觉得就很简单了，懂音乐的人很少懂计算机，懂计算机的人很少懂音乐，所以很多工作我一看就觉得方向不对，因为正常人可不是这么作曲的。

### 算法

不说这么多，下面讲讲我自己思考实现的方法。

很显然这是一个时序的离散优化问题，那么首先很自然可以提出基于搜索的回溯算法，只要从头到尾从可选集中依次选出一个和弦，遇到不可调解的矛盾就回溯到关键节点，如同CDCL算法解SAT问题。对，这个问题也可以化成SAT问题，但是会变得很冗长，因为需要用二元变量编码多元取值和时序规则。

如果加上一些forward looking的信息，还可以提出改进的带插入值的回溯算法。原因是当我们创作时不是完全按照时间顺序去解这个问题，有时候我们会提前想好，比如曲子的中间有一个离调，曲子的结尾时阻碍终止，这意味着最终可能要以六级和弦结尾，而不是主和弦。此时我们就可以要求回溯法的解必须经过这些关键节点，于是就可以做改进，回溯的时候单调扩充每个插入点之前的可行集，直到包含插入点。

### 解增强

我们说到这里，这个问题好像已经解决了。但其实这个问题和类似的问题，例如SAT，有一个显著不同的地方。SAT问题只要有一个满足就可以了，但对于和声问题，可行解一般而言数量并不少，所以其实算法很快就能找到一个可行解。问题是，这些可行解有很多其实是不好的解。例如只要拼命地使用主和弦，下属和弦和属和弦，很容易就能找到一个解。

我的意识，人类创作音乐是有模式的，例如这一步到了属七和弦，下一个和弦一般都会解决到主和弦，如果这时算法还选择一个比如二和弦，一般而言就会走到一个奇怪的地方，且就算走通了，这个解也怪怪的。这个和弦进行套什么旋律好像都不太会觉得难听，甚至很多流行音乐就是基于这个和弦进行来创作，因此才会有口水歌的感觉。但对于任意一个旋律，这个进行一般都不好，因此这不是我们想要的解决方案。

既然想建模模式，就可以上各种统计模型了。马尔科夫链、或者一些网络的模型，然后把这些模型作为先验加到回溯法里面。

我稍微提提我尝试过做法。

最简单的是马尔可夫模型，然后就是一些NN based的模型，还有分块的吉布斯抽样。

这是我用LSTM和NN在一些数据集上训练的效果，如果用NLL loss的话，马尔可夫大概是2.1，NN能到2，LSTM大约是1.8。这里我放了一个生成的例子，不太确定能不能放出来。

我今天大概讲这么多，然后这个项目的implementation我放在我github上，大家有兴趣可以去玩玩。