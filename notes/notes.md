## 自动和声问题

本文档对给定自动生成和声问题做一个简单的介绍。

### 简介

首先介绍一下自动和声在试图解决一个什么问题，这个问题可能需要一定的音乐知识听起来才会好理解，因此我会尽量讲的直白一些。我们可以从两个维度看一个音乐，时序上来看就是一首作品的旋律的演进，在截面上就是每一个时刻有多少个频率或者不同音色。对于音乐创作来说，一种很常见的做法就是我先有一段旋律，然后以此为中心进行扩展。对于这种工作流来说，给指定旋律配和弦就是一个绕不开的问题。总的来说不管乱配和弦还是很精巧地配，和弦，或者说和声这件事，它就很重要，基本上好的曲子没有和弦差的。

我们来具体看配和弦这件事，如果大家见过一些简单的钢琴曲演奏的话，很常见的就是右手是旋律，左手是和弦，所以大家应该很容易理解配和弦是在做一件什么事，简单但很概括地来说就是在每一个需要配和弦的旋律音上加一个和弦。为什么这件事会成为一个问题，原因就是和弦不能乱配，你随机在钢琴上选几个琴键敲下去大概率就是很难听的。音乐发展了这么多年，人们已经总结了很多关于和弦进行的规则，简单来说我们就是要找出符合规则的好的和弦进行。

### 规则如何工作

所有关于和声的规则无非是从截面上和时序上对和声进行限制。例如，禁止出现平行或者隐伏的八五度；低音减四度下行而不是增五度上行；避免四部同向等。这个例子里从A Major到G Major，他们的根音和五音是一个平行关系，这就违反了平行五度的规则。实际上如果你去听这个和弦进行，你会觉得本来是四个声部的东西，女高和女低好像只有一个声部，因为五度的音听起来太和谐了，就和八度一样，它们分别对应大约1.5倍和2倍的频率。如果看频谱图他们在根音两个周期上有重合，这是现代的解释。

### 数学描述

有了前面的一些基本介绍，我们可以用数学的语言来精确描述给旋律配和弦这个问题。大T是时间长度，小m是用来描述旋律的维度，例如就是1，小c是用来描述和弦的维度，例如只考虑三和弦和七和弦，自然小调就是4维。其中Rule是一个规则函数，它判断一个和弦进行是否打破了规则。Score是一个分数函数，描述有多违反规则。我们一般使用score函数，因为有一些规则是软的，可以打破，但不太好，有一些规则是绝对不能碰的。一个例子，平行八五度就可以这么描述。

### 相关工作

在讲我自己实现的算法之前我们快速过一下这个问题上人们已有的工作。据我所知这一块真的没什么好的工作，我不知道什么原因。我大概是半年前开始接触编曲，以我的知识背景我当时立刻就想到这个东西至少可以用强化学习方法试试，然后到这学期上这门课我觉得他就是一个组合优化问题。目前我查阅的文献来看，这一块主要是两种主流的做法，一种就是纯的基于规则-检查的方法。这一种范式在上世纪五六十年代就有人尝试，最开始是Pachet的这篇通过随机产生音符来生成弦乐四重奏。后来陆陆续续有一些这方面的工作，但只有很少用组合问题的方法来求解。在这之中有一种做法是基于字典，就是存一个很大的常见的和弦进行，然后挑一个比较好的。一些商业的作曲软件就是这么个做法，例如说流行音乐里用烂的所谓4536251进行，说白了就是下属-属-主功能组的和弦进行。另外的一类做法就是纯的基于统计模型的方法，将这个问题看作是一个抽样问题，也就是从和弦的边缘分布中抽样。这里就各种各种乱七八糟的方法就都上了，隐马尔可夫、吉布斯抽样，变分推断。最近今年有一些用深度学习来给边缘概率建模的做法。从我所看到的文章中，就没有人把这两种方法合起来。或者说没有文章从正常作曲的角度来求解这个问题。

### 算法

下面讲讲我自己思考实现的方法。

很显然这是一个时序的离散优化问题，那么首先很自然可以提出基于搜索的回溯算法，只要从头到尾从可选集中依次选出一个和弦，遇到不可调解的矛盾就回溯到关键节点，如同CDCL算法解SAT问题。对，这个问题也可以化成SAT问题，但是会变得很冗长，因为需要用二元变量编码多元取值和时序规则。

如果加上一些forward looking的信息，还可以提出改进的带插入值的回溯算法。原因是当我们创作时不是完全按照时间顺序去解这个问题，有时候我们会提前想好，比如曲子的中间有一个离调，曲子的结尾时阻碍终止，这意味着最终可能要以六级和弦结尾，而不是主和弦。此时我们就可以要求回溯法的解必须经过这些关键节点，于是就可以做改进，回溯的时候单调扩充每个插入点之前的可行集，直到包含插入点。

### 解增强

我们说到这里，这个问题好像已经解决了。但其实这个问题和类似的问题，例如SAT，有一个显著不同的地方。SAT问题只要有一个满足就可以了，但对于和声问题，可行解一般而言数量并不少，所以其实算法很快就能找到一个可行解。问题是，这些可行解有很多其实是不好的解。例如只要拼命地使用主和弦，下属和弦和属和弦，很容易就能找到一个解。

我的意识，人类创作音乐是有模式的，例如这一步到了属七和弦，下一个和弦一般都会解决到主和弦，如果这时算法还选择一个比如二和弦，一般而言就会走到一个奇怪的地方，且就算走通了，这个解也怪怪的。这个和弦进行套什么旋律好像都不太会觉得难听，甚至很多流行音乐就是基于这个和弦进行来创作，因此才会有口水歌的感觉。但对于任意一个旋律，这个进行一般都不好，因此这不是我们想要的解决方案。

既然想建模模式，就可以上各种统计模型了。马尔科夫链、或者一些网络的模型，然后把这些模型作为先验加到回溯法里面。

我稍微提提我尝试过做法。

最简单的是马尔可夫模型，然后就是一些NN based的模型，还有分块的吉布斯抽样。

这是我用LSTM和NN在一些数据集上训练的效果，如果用NLL loss的话，马尔可夫大概是2.1，NN能到2，LSTM大约是1.8。这里我放了一个生成的例子，不太确定能不能放出来。

我今天大概讲这么多，然后这个项目的implementation我放在我github上，大家有兴趣可以去玩玩。